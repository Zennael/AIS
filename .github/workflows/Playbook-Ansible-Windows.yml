name: Ansible Playbook Windows 

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ansible'
        required: true
        default: 'Playbook'

jobs:
  configure-windows:
    runs-on: windows-latest
    outputs:
      windows_ip: ${{ steps.get_ip.outputs.ip }}
    steps:
    - name: Configure Static IP
      id: set_ip
      run: |
        $interface = Get-NetAdapter | Where-Object { $_.Status -eq 'Up' }
        New-NetIPAddress -InterfaceIndex $interface.ifIndex -IPAddress 192.168.1.100 -PrefixLength 24 -DefaultGateway 192.168.1.1
        Set-DnsClientServerAddress -InterfaceIndex $interface.ifIndex -ServerAddresses 8.8.8.8,8.8.4.4
        $ip = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object { $_.IPAddress -eq '192.168.1.100' }).IPAddress
        echo "::set-output name=ip::$ip"

    - name: Configure WinRM
      run: |
        Enable-PSRemoting -Force
        Set-Item wsman:\localhost\Service\Auth\Basic -Value $true
        Set-Item wsman:\localhost\Service\AllowUnencrypted -Value $true
        Restart-Service WinRM

  run-ansible:
    runs-on: ubuntu-latest
    needs: configure-windows
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Install Ansible and Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ansible
        python3 -m pip install --upgrade pip
        pip install pywinrm

    - name: Run Ansible Playbook
      env:
        ANSIBLE_HOST_KEY_CHECKING: "False"
      run: |
        ansible-playbook -i Ansible/inventory.ini Ansible/PlaybookWindows.yaml
